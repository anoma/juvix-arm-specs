module Anoma.Proving.Types;

import Stdlib.Prelude open;
import Stdlib.Trait.Ord.Eq open using {fromOrdToEq};
import Data.Set as Set open using {Set};
import Anoma.Resource.Object open using {Resource};
import Anoma.Resource.Types open using {Commitment; Nullifier};
import Anoma.Resource.Computable.Commitment open using {module CommitmentInternal};
import Anoma.Resource.Computable.Nullifier open using {module NullfierInternal};
import Anoma.Transaction.AppData open using {AppData};
import Anoma.Builtin.System open using {AnomaOpaque};
import Anoma.Utils open;

--- A record describing a proof record, a map entry constituted by a VerifyingKey as the lookup-key
--- and a Proof and associated instance as the value.
GenericProofRecord (Proof VerifyingKey Instance : Type) : Type :=
  Pair VerifyingKey (Pair Proof Instance);

module Delta;
  type Proof := mkProof {unProof : AnomaOpaque};

  type VerifyingKey := mkVerifyingKey {unVerifyingKey : UNUSED};

  type ProvingKey := mkProvingKey {unProvingKey : UNUSED};

  type Instance := mkInstance {unInstance : UNUSED};

  type Witness := mkWitness {unWitness : UNUSED};

  module ProofInternal;
    --- Compares two ;Proof; objects.
    compare (lhs rhs : Proof) : Ordering := Ord.cmp (Proof.unProof lhs) (Proof.unProof rhs);

    --- Implements the ;Ord; trait for ;Proof;.
    instance
    Proof-Ord : Ord Proof := mkOrd compare;

    --- Implements the ;Eq; trait for ;Proof;.
    instance
    Proof-Eq : Eq Proof := fromOrdToEq;
  end;

  module VerifyingKeyInternal;
    --- Compares two ;VerifyingKey; objects.
    compare (lhs rhs : VerifyingKey) : Ordering :=
      Ord.cmp (VerifyingKey.unVerifyingKey lhs) (VerifyingKey.unVerifyingKey rhs);

    --- Implements the ;Ord; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Ord : Ord VerifyingKey := mkOrd compare;

    --- Implements the ;Eq; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Eq : Eq VerifyingKey := fromOrdToEq;
  end;

  module InstanceInternal;
    --- Compares two ;Instance; objects.
    compare (lhs rhs : Instance) : Ordering :=
      Ord.cmp (Instance.unInstance lhs) (Instance.unInstance rhs);

    --- Implements the ;Ord; trait for ;Instance;.
    instance
    Instance-Ord : Ord Instance := mkOrd compare;

    --- Implements the ;Eq; trait for ;Instance;.
    instance
    Instance-Eq : Eq Instance := fromOrdToEq;
  end;

  module WitnessInternal;
    --- Compares two ;Witness; objects.
    compare (lhs rhs : Witness) : Ordering :=
      Ord.cmp (Witness.unWitness lhs) (Witness.unWitness rhs);

    --- Implements the ;Ord; trait for ;Witness;.
    instance
    Witness-Ord : Ord Witness := mkOrd compare;

    --- Implements the ;Eq; trait for ;Witness;.
    instance
    Witness-Eq : Eq Witness := fromOrdToEq;
  end;
end;

module ResourceLogic;
  type Proof := mkProof {unProof : AnomaOpaque};

  type VerifyingKey := mkVerifyingKey {unVerifyingKey : UNUSED};

  type ProvingKey := mkProvingKey {unProvingKey : Resource};

  --- The reference to the ;Resource; carrying the logic function.
  type Tag :=
    | Created Commitment
    | Consumed Nullifier;

  --- The public inputs (Instance) of the resource logic function proof.
  type Instance :=
    mkInstance {
      tag : Tag;
      commitments : Set Commitment;
      nullifiers : Set Nullifier;
      appData : AppData
    };

  --- Custom inputs of the resource logic function proof being defined on the application level.
  --- TODO To support the definition of ;CustomInputs; on the application level, Juvix must support existential types.
  --- NOTE: For the private testnet, this can be of type ;AppData;.
  CustomInputs : Type := AppData;

  --- The private inputs (Witness) of the resource logic function proof.
  type Witness :=
    mkWitness {
      created : Set Resource;
      consumed : Set Resource;
      custom : CustomInputs
    };

  module TagInternal;
    --- Compares two ;CustomInputs; objects.
    --- Lexicographical ordering with `Created _ < Consumed _`.
    compare (lhs rhs : Tag) : Ordering :=
      case lhs, rhs of
        | Created cmLhs, Created cmRhs := Ord.cmp cmLhs cmRhs
        | Consumed nfLhs, Consumed nfRhs := Ord.cmp nfLhs nfRhs
        | Created _, Consumed _ := LT
        | Consumed _, Created _ := GT;

    --- Implements the ;Ord; trait for ;Tag;.
    instance
    Tag-Ord : Ord Tag := mkOrd compare;

    --- Implements the ;Eq; trait for ;Tag;.
    instance
    Tag-Eq : Eq Tag := fromOrdToEq;
  end;

  module ProofInternal;
    --- Compares two ;Proof; objects.
    compare (lhs rhs : Proof) : Ordering := Ord.cmp (Proof.unProof lhs) (Proof.unProof rhs);

    --- Implements the ;Ord; trait for ;Proof;.
    instance
    Proof-Ord : Ord Proof := mkOrd compare;

    --- Implements the ;Eq; trait for ;Proof;.
    instance
    Proof-Eq : Eq Proof := fromOrdToEq;
  end;

  module VerifyingKeyInternal;
    --- Compares two ;VerifyingKey; objects.
    compare (lhs rhs : VerifyingKey) : Ordering :=
      Ord.cmp (VerifyingKey.unVerifyingKey lhs) (VerifyingKey.unVerifyingKey rhs);

    --- Implements the ;Ord; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Ord : Ord VerifyingKey := mkOrd compare;

    --- Implements the ;Eq; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Eq : Eq VerifyingKey := fromOrdToEq;
  end;

  module InstanceInternal;
    --- Compares two ;Instance; objects.
    compare (lhs rhs : Instance) : Ordering :=
      let
        prod (i : Instance) : _ :=
          Instance.tag i, Instance.commitments i, Instance.nullifiers i, Instance.appData i;
      in Ord.cmp (prod lhs) (prod rhs);

    --- Implements the ;Ord; trait for ;Instance;.
    instance
    Instance-Ord : Ord Instance := mkOrd compare;

    --- Implements the ;Eq; trait for ;Instance;.
    instance
    Instance-Eq : Eq Instance := fromOrdToEq;
  end;

  module WitnessInternal;
    --- Compares two ;Witness; objects.
    compare (lhs rhs : Witness) : Ordering :=
      let
        prod (w : Witness) : _ := Witness.created w, Witness.consumed w, Witness.custom w;
      in Ord.cmp (prod lhs) (prod rhs);

    --- Implements the ;Ord; trait for ;Witness;.
    instance
    Witness-Ord : Ord Witness := mkOrd compare;

    --- Implements the ;Eq; trait for ;Witness;.
    instance
    Witness-Eq : Eq Witness := fromOrdToEq;
  end;
end;

-- Is this what is meant by action compliance in the RM interface?
-- https://github.com/anoma/anoma/blob/2bd7784de9543d9cfc85ed49bd77cec549f8249c/hoon/resource-machine.hoon#L90
module Compliance;
  type Proof := mkProof {unProof : AnomaOpaque};

  type VerifyingKey := mkVerifyingKey {unVerifyingKey : UNUSED};

  type ProvingKey := mkProvingKey {unProvingKey : UNUSED};

  type Instance := mkInstance {unInstance : UNUSED};

  type Witness := mkWitness {unWitness : UNUSED};

  module ProofInternal;
    --- Compares two ;Proof; objects.
    compare (lhs rhs : Proof) : Ordering := Ord.cmp (Proof.unProof lhs) (Proof.unProof rhs);

    --- Implements the ;Ord; trait for ;Proof;.
    instance
    Proof-Ord : Ord Proof := mkOrd compare;

    --- Implements the ;Eq; trait for ;Proof;.
    instance
    Proof-Eq : Eq Proof := fromOrdToEq;
  end;

  module VerifyingKeyInternal;
    --- Compares two ;VerifyingKey; objects.
    compare (lhs rhs : VerifyingKey) : Ordering :=
      Ord.cmp (VerifyingKey.unVerifyingKey lhs) (VerifyingKey.unVerifyingKey rhs);

    --- Implements the ;Ord; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Ord : Ord VerifyingKey := mkOrd compare;

    --- Implements the ;Eq; trait for ;VerifyingKey;.
    instance
    VerifyingKey-Eq : Eq VerifyingKey := fromOrdToEq;
  end;

  module InstanceInternal;
    --- Compares two ;Instance; objects.
    compare (lhs rhs : Instance) : Ordering :=
      Ord.cmp (Instance.unInstance lhs) (Instance.unInstance rhs);

    --- Implements the ;Ord; trait for ;Instance;.
    instance
    Instance-Ord : Ord Instance := mkOrd compare;

    --- Implements the ;Eq; trait for ;Instance;.
    instance
    Instance-Eq : Eq Instance := fromOrdToEq;
  end;

  module WitnessInternal;
    --- Compares two ;Witness; objects.
    compare (lhs rhs : Witness) : Ordering :=
      Ord.cmp (Witness.unWitness lhs) (Witness.unWitness rhs);

    --- Implements the ;Ord; trait for ;Witness;.
    instance
    Witness-Ord : Ord Witness := mkOrd compare;

    --- Implements the ;Eq; trait for ;Witness;.
    instance
    Witness-Eq : Eq Witness := fromOrdToEq;
  end;
end;
